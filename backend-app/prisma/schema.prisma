// DATASOURCE + GENERATOR
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ENUMS
enum GroupRole {
  MEMBER
  ADMIN
}

enum SplitType {
  EQUAL
  EXACT
  PERCENT
}

// MODELS

// USER MODEL
model User {
  id          Int      @id @default(autoincrement())
  firebaseUid String   @unique
  email       String?  @unique
  name        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  groupsCreated        Group[]              @relation("GroupCreator")
  groupMembers         GroupMember[]
  expensesPaid         Expense[]            @relation("ExpensePaidBy")
  expensesCreated      Expense[]            @relation("ExpenseCreatedBy")
  expenseParticipants  ExpenseParticipant[] // REQUIRED reverse relation

  settlementsPaid      Settlement[]         @relation("SettlementPaidBy")
  settlementsRecv      Settlement[]         @relation("SettlementPaidTo")
}

// GROUP MODEL
model Group {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy  User          @relation("GroupCreator", fields: [createdById], references: [id])
  members    GroupMember[]
  expenses   Expense[]

  settlements Settlement[]  // REQUIRED reverse relation
}

// GROUP MEMBER
model GroupMember {
  id        Int       @id @default(autoincrement())
  groupId   Int
  userId    Int
  role      GroupRole @default(MEMBER)
  createdAt DateTime  @default(now())

  group Group @relation(fields: [groupId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([groupId, userId])
}

// EXPENSE MODEL
model Expense {
  id          Int        @id @default(autoincrement())
  description String
  amount      Decimal
  splitType   SplitType
  groupId     Int?
  paidById    Int
  createdById Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  group     Group? @relation(fields: [groupId], references: [id])

  paidBy    User   @relation("ExpensePaidBy", fields: [paidById], references: [id])
  createdBy User   @relation("ExpenseCreatedBy", fields: [createdById], references: [id])

  participants ExpenseParticipant[]
}

// EXPENSE PARTICIPANTS
model ExpenseParticipant {
  id        Int     @id @default(autoincrement())
  expenseId Int
  userId    Int
  share     Decimal

  expense Expense @relation(fields: [expenseId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([expenseId, userId])
}

// SETTLEMENTS
model Settlement {
  id        Int      @id @default(autoincrement())
  groupId   Int?
  paidById  Int
  paidToId  Int
  amount    Decimal
  createdAt DateTime @default(now())

  group Group? @relation(fields: [groupId], references: [id])

  paidBy User @relation("SettlementPaidBy", fields: [paidById], references: [id])
  paidTo User @relation("SettlementPaidTo", fields: [paidToId], references: [id])
}
